stages:
  - test_build
  - production
  - deploy

variables:
  PRODUCTION_NAMESPACE: default
  DOCKER_DRIVER: overlay2
  PRODUCTION_NAMESPACE: production
  PREFIX: ""
  RELEASE_NAME: ${PREFIX}${CI_PROJECT_NAME}
  RELEASE_NAME_SYNCH: ${PREFIX}${CI_PROJECT_NAME}-synch
  RELEASE_NAME_SOAP1C: ${PREFIX}${CI_PROJECT_NAME}-soap1c
  CONTAINER_IMAGE: ${PREFIX}${CI_PROJECT_NAME}:${CI_BUILD_REF}
  CONTAINER_IMAGE_LATEST: ${PREFIX}${CI_PROJECT_NAME}:latest

test_build:
  image: node:13
  stage: test_build
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      - node_modules/
      - apps/portal/.next/cache/
  script:
    - env && echo -n "node version " && node -v
    # - apt-get upgrade && apt-get install -y openssl libpq-dev
    - yarn install --production=false
    - cd apps/portal && npx next telemetry status && npx next telemetry disable && cd ../..
    - ./entrypoint.sh test -u
    - time yarn build
    - time yarn build:synch
    - time yarn build:jobSynch
    # - time yarn build:soap1c
  artifacts:
    paths:
      - .next/
      - dist
    expire_in: 16 hours

prepare:
  image: node:13
  stage: test_build
  cache:
    key: "${CI_COMMIT_REF_SLUG}-build"
    paths:
      - node_modules/
  script:
    - env && echo -n "node version " && node -v
    # - apt-get upgrade && apt-get install -y openssl libpq-dev
    - yarn install --production=true

production:
  image: docker:latest
  stage: production
  cache:
    key: "${CI_COMMIT_REF_SLUG}-build"
    paths:
      - node_modules/
    policy: pull
  script:
    - |
      \
      if [ ! -d "node_modules" ]; then echo '!! CACHE NOT EXIST !!'; exit SIGINT; fi
    # TODO: авторизация по логину, пока нету, так что у нас в открытом доступе по docker-registry.kngk.org лежит куча portal-ов
    # - docker login
    - docker build --tag ${CONTAINER_IMAGE} .
    - docker tag ${CONTAINER_IMAGE} ${CONTAINER_IMAGE_LATEST}
    - docker tag ${CONTAINER_IMAGE} ${DOCKER_REGISTRY}/${CONTAINER_IMAGE}
    - docker tag ${CONTAINER_IMAGE} ${DOCKER_REGISTRY}/${CONTAINER_IMAGE_LATEST}
    - docker push ${DOCKER_REGISTRY}/${CONTAINER_IMAGE}

deploy:
  image: dtzar/helm-kubectl:latest
  stage: deploy
  dependencies: []
  when: manual
  allow_failure: false
  script:
    - env
    # Portal
    - |
      helm upgrade ${RELEASE_NAME} helm/portal \
        --install --namespace=${PRODUCTION_NAMESPACE} \
        --debug --values helm/portal/values.yaml \
        --set HOST="${HOST}" \
        --set PORT="${PORT}" \
        --set PORT_DEBUGGER="${PORT_DEBUGGER}" \
        --set DATABASE_URI="${DATABASE_URI}" \
        --set DATABASE_URI_RD="${DATABASE_URI_RD}" \
        --set DATABASE_SCHEMA="${DATABASE_SCHEMA}" \
        --set DATABASE_SYNCHRONIZE="${DATABASE_SYNCHRONIZE}" \
        --set DATABASE_DROP_SCHEMA="${DATABASE_DROP_SCHEMA}" \
        --set DATABASE_MIGRATIONS_RUN="${DATABASE_MIGRATIONS_RUN}" \
        --set DATABASE_LOGGING="${DATABASE_LOGGING}" \
        --set DATABASE_REDIS_URI="${DATABASE_REDIS_URI}" \
        --set DATABASE_REDIS_TTL="${DATABASE_REDIS_TTL}" \
        --set HTTP_REDIS_URI="${HTTP_REDIS_URI}" \
        --set HTTP_REDIS_TTL="${HTTP_REDIS_TTL}" \
        --set HTTP_REDIS_MAX_OBJECTS="${HTTP_REDIS_MAX_OBJECTS}" \
        --set SESSION_REDIS_URI="${SESSION_REDIS_URI}" \
        --set SESSION_COOKIE_TTL="${SESSION_COOKIE_TTL}" \
        --set SESSION_SECRET="${SESSION_SECRET}" \
        --set LDAP_URL="${LDAP_URL}" \
        --set LDAP_BIND_DN="${LDAP_BIND_DN}" \
        --set LDAP_BIND_PW="${LDAP_BIND_PW}" \
        --set LDAP_SEARCH_BASE="${LDAP_SEARCH_BASE}" \
        --set LDAP_SEARCH_FILTER="${LDAP_SEARCH_FILTER}" \
        --set LDAP_SEARCH_GROUP="${LDAP_SEARCH_GROUP}" \
        --set LDAP_SEARCH_BASE_ALL_USERS="${LDAP_SEARCH_BASE_ALL_USERS}" \
        --set LDAP_SEARCH_FILTER_ALL_USERS="${LDAP_SEARCH_FILTER_ALL_USERS}" \
        --set LDAP_REDIS_URI="${LDAP_REDIS_URI}" \
        --set LDAP_REDIS_TTL="${LDAP_REDIS_TTL}" \
        --set MICROSERVICE_URL="${MICROSERVICE_URL}" \
        --set MICROSERVICE_USER="${MICROSERVICE_USER}" \
        --set MICROSERVICE_PASS="${MICROSERVICE_PASS}" \
        --set SOAP_URL="${SOAP_URL}" \
        --set SOAP_USER="${SOAP_USER}" \
        --set SOAP_PASS="${SOAP_PASS}" \
        --set NEWS_URL="${NEWS_URL}" \
        --set NEWS_API_URL="${NEWS_API_URL}" \
        --set MAIL_URL="${MAIL_URL}" \
        --set MAIL_LOGIN_URL="${MAIL_LOGIN_URL}" \
        --set MEETING_URL="${MEETING_URL}" \
        --set image.repository="${DOCKER_REGISTRY}/${RELEASE_NAME}" \
        --set image.tag="${CI_BUILD_REF}"
    # Portal-synch
    - |
      helm upgrade ${RELEASE_NAME_SYNCH} helm/portal-synch \
        --install --namespace=${PRODUCTION_NAMESPACE} \
        --debug --values helm/portal-synch/values.yaml \
        --set HOST="${HOST}" \
        --set PORT="${PORT_MICROSERVICE}" \
        --set PORT_DEBUGGER="${PORT_DEBUGGER}" \
        --set image.repository="${DOCKER_REGISTRY}/${RELEASE_NAME}" \
        --set image.tag="${CI_BUILD_REF}"
    # Portal-soap1c
    # - |
    #   helm upgrade ${RELEASE_NAME_SOAP1C} helm/portal-soap1c \
    #     --install --namespace=${PRODUCTION_NAMESPACE} \
    #     --debug --values helm/portal-soap1c/values.yaml \
    #     --set HOST="${HOST}" \
    #     --set PORT="${PORT_MICROSERVICE}" \
    #     --set PORT_DEBUGGER="${PORT_DEBUGGER}" \
    #     --set image.repository="${DOCKER_REGISTRY}/${RELEASE_NAME}" \
    #     --set image.tag="${CI_BUILD_REF}"
